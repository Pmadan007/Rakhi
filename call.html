<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rakhi Video Call</title>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f2f2f2;
    }

    h1 {
      margin-top: 20px;
    }

    #loading {
      margin: 20px;
      padding: 20px;
      background: #fff3cd;
      border-radius: 5px;
      color: #856404;
    }

    #error {
      margin: 20px;
      padding: 20px;
      background: #f8d7da;
      border-radius: 5px;
      color: #721c24;
    }

    #status {
      margin: 10px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }

    #controls {
      margin: 10px;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    #video-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    video {
      width: 300px;
      height: 200px;
      background: black;
      border-radius: 10px;
      object-fit: cover;
    }

    .peer-wrapper {
      position: relative;
      display: inline-block;
    }

    .peer-name {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: white;
      background: rgba(0,0,0,0.7);
      padding: 5px;
      border-radius: 5px;
      font-size: 12px;
    }

    .audio-only {
      width: 300px;
      height: 200px;
      background: #333;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-direction: column;
    }

    .debug-info {
      margin: 10px;
      padding: 10px;
      background: #e2e3e5;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      max-width: 800px;
      max-height: 200px;
      overflow-y: auto;
    }

    .fallback-notice {
      margin: 20px;
      padding: 20px;
      background: #d1ecf1;
      border-radius: 5px;
      color: #0c5460;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>üé• Raksha Bandhan Call</h1>
  
  <div id="loading">Loading video call...</div>
  <div id="error" style="display: none;"></div>
  <div id="debug" class="debug-info" style="display: none;"></div>
  <div id="status" style="display: none;"></div>
  <div id="controls" style="display: none;">
    <button id="toggleAudio" class="btn-primary">üé§ Toggle Audio</button>
    <button id="toggleVideo" class="btn-primary">üìπ Toggle Video</button>
    <button id="leaveRoom" class="btn-danger">üö™ Leave Room</button>
  </div>
  <div id="video-container"></div>

  <script>
    let currentStream = null;
    let isAudioMuted = false;
    let isVideoMuted = false;

    // Debug function
    function addDebugInfo(message) {
      const debugDiv = document.getElementById('debug');
      debugDiv.style.display = 'block';
      debugDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
      console.log(message);
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.style.display = 'block';
      errorDiv.innerHTML = `‚ùå ${message}`;
      addDebugInfo(`ERROR: ${message}`);
    }

    function updateStatus(message, bgColor, textColor) {
      const statusDiv = document.getElementById('status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = message;
      statusDiv.style.background = bgColor;
      statusDiv.style.color = textColor;
    }

    // Try to load HMS SDK dynamically with multiple fallback URLs
    async function loadHMSSDK() {
      const sdkUrls = [
        'https://unpkg.com/@100mslive/hms-video-store@latest/dist/index.js',
        'https://cdn.jsdelivr.net/npm/@100mslive/hms-video-store@latest/dist/index.js',
        'https://sdk.100ms.live/web/hms.js'
      ];

      for (const url of sdkUrls) {
        try {
          addDebugInfo(`Trying to load HMS SDK from: ${url}`);
          
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
            
            // Timeout after 10 seconds
            setTimeout(() => reject(new Error('Timeout')), 10000);
          });

          // Wait for SDK to initialize
          await new Promise(resolve => setTimeout(resolve, 1000));

          // Check if HMS is available
          if (typeof HMSReactiveStore !== 'undefined') {
            addDebugInfo('‚úÖ HMS SDK loaded successfully!');
            return true;
          } else if (typeof HMS !== 'undefined') {
            addDebugInfo('‚úÖ HMS object found, setting up HMSReactiveStore...');
            window.HMSReactiveStore = HMS.HMSReactiveStore || HMS;
            return true;
          }

          addDebugInfo(`‚ùå HMS objects not found from ${url}`);
        } catch (error) {
          addDebugInfo(`‚ùå Failed to load from ${url}: ${error.message}`);
        }
      }

      return false;
    }

    // HMS-based implementation
    async function initializeHMSCall(roomId, role, authToken) {
      try {
        const hmsStore = new HMSReactiveStore.HMSStore();
        const hmsActions = new HMSReactiveStore.HMSActions(hmsStore);
        const hmsNotifications = new HMSReactiveStore.HMSNotifications(hmsStore);

        // Set up notifications
        hmsNotifications.onNotification((notification) => {
          addDebugInfo(`HMS Notification: ${notification.type}`);
          if (notification.type === 'ERROR') {
            showError(`HMS Error: ${notification.data.message}`);
          }
        });

        // Subscribe to store changes
        hmsStore.subscribe((store) => {
          addDebugInfo(`Store update: connected=${store.isConnected}, peers=${Object.keys(store.peers).length}`);
          
          if (store.isConnected) {
            updateStatus(`‚úÖ Connected as ${store.localPeer?.name} | Peers: ${Object.keys(store.peers).length}`, '#d4edda', '#155724');
            document.getElementById('controls').style.display = 'flex';
          } else {
            updateStatus('üîÑ Connecting...', '#fff3cd', '#856404');
          }

          // Update video container
          const container = document.getElementById('video-container');
          container.innerHTML = '';

          Object.values(store.peers).forEach(peer => {
            if (peer.videoTrack) {
              const videoTrack = store.tracks[peer.videoTrack];
              if (videoTrack && videoTrack.enabled) {
                const wrapper = document.createElement('div');
                wrapper.className = 'peer-wrapper';
                
                const video = document.createElement('video');
                video.autoplay = true;
                video.playsInline = true;
                video.muted = peer.isLocal;
                
                const nameLabel = document.createElement('div');
                nameLabel.className = 'peer-name';
                nameLabel.textContent = peer.name + (peer.isLocal ? ' (You)' : '');
                
                wrapper.appendChild(video);
                wrapper.appendChild(nameLabel);
                container.appendChild(wrapper);
                
                hmsActions.attachVideo(videoTrack.id, video);
              }
            } else if (peer.audioTrack) {
              const audioDiv = document.createElement('div');
              audioDiv.className = 'audio-only';
              audioDiv.innerHTML = `
                <div style="font-size: 48px;">üé§</div>
                <div style="margin-top: 10px;">${peer.name}${peer.isLocal ? ' (You)' : ''}</div>
              `;
              container.appendChild(audioDiv);
            }
          });
        });

        // Join room
        await hmsActions.join({
          userName: role === "sister" ? "Sister" : "Brother",
          authToken: authToken,
          settings: {
            isAudioMuted: false,
            isVideoMuted: false,
          },
        });

        // Set up controls
        document.getElementById('toggleAudio').onclick = async () => {
          await hmsActions.setLocalAudioEnabled(isAudioMuted);
          isAudioMuted = !isAudioMuted;
        };

        document.getElementById('toggleVideo').onclick = async () => {
          await hmsActions.setLocalVideoEnabled(isVideoMuted);
          isVideoMuted = !isVideoMuted;
        };

        document.getElementById('leaveRoom').onclick = async () => {
          await hmsActions.leave();
          container.innerHTML = '';
          document.getElementById('controls').style.display = 'none';
          updateStatus('üëã Left the room', '#d1ecf1', '#0c5460');
        };

        addDebugInfo('‚úÖ HMS call initialized successfully');

      } catch (error) {
        addDebugInfo(`‚ùå HMS call failed: ${error.message}`);
        throw error;
      }
    }

    // Fallback WebRTC implementation
    async function initializeFallbackCall(roomId, role) {
      addDebugInfo('Using fallback WebRTC implementation');
      
      const container = document.getElementById('video-container');
      document.getElementById('controls').style.display = 'flex';
      
      // Add fallback notice
      const notice = document.createElement('div');
      notice.className = 'fallback-notice';
      notice.innerHTML = `
        <strong>üìπ Local Camera Mode</strong><br>
        HMS SDK couldn't load, showing your local camera only.<br>
        Share this URL with others: <code>${window.location.href}</code>
      `;
      document.body.insertBefore(notice, container);

      try {
        // Get user media
        currentStream = await navigator.mediaDevices.getUserMedia({ 
          video: true, 
          audio: true 
        });

        const wrapper = document.createElement('div');
        wrapper.className = 'peer-wrapper';
        
        const video = document.createElement('video');
        video.srcObject = currentStream;
        video.autoplay = true;
        video.playsInline = true;
        video.muted = true;
        
        const nameLabel = document.createElement('div');
        nameLabel.className = 'peer-name';
        nameLabel.textContent = `${role === 'sister' ? 'Sister' : 'Brother'} (You)`;
        
        wrapper.appendChild(video);
        wrapper.appendChild(nameLabel);
        container.appendChild(wrapper);

        updateStatus('‚úÖ Local camera connected (Fallback mode)', '#d4edda', '#155724');

        // Set up fallback controls
        document.getElementById('toggleAudio').onclick = () => {
          const audioTracks = currentStream.getAudioTracks();
          audioTracks.forEach(track => {
            track.enabled = !track.enabled;
            isAudioMuted = !track.enabled;
          });
          document.getElementById('toggleAudio').textContent = 
            isAudioMuted ? 'üîá Unmute Audio' : 'üé§ Mute Audio';
        };

        document.getElementById('toggleVideo').onclick = () => {
          const videoTracks = currentStream.getVideoTracks();
          videoTracks.forEach(track => {
            track.enabled = !track.enabled;
            isVideoMuted = !track.enabled;
          });
          document.getElementById('toggleVideo').textContent = 
            isVideoMuted ? 'üì∑ Enable Video' : 'üìπ Disable Video';
        };

        document.getElementById('leaveRoom').onclick = () => {
          if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
          }
          container.innerHTML = '';
          document.getElementById('controls').style.display = 'none';
          updateStatus('üëã Left the room', '#d1ecf1', '#0c5460');
        };

      } catch (error) {
        showError(`Camera access failed: ${error.message}`);
      }
    }

    // Main application logic
    async function initializeApp() {
      const loadingDiv = document.getElementById('loading');
      
      try {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get("room");
        const role = urlParams.get("role") || "sister";

        if (!roomId) {
          throw new Error("No room ID provided in URL. Please add ?room=YOUR_ROOM_ID to the URL");
        }

        addDebugInfo(`Starting app: room=${roomId}, role=${role}`);

        // Try to load HMS SDK
        const hmsLoaded = await loadHMSSDK();
        
        if (hmsLoaded) {
          // Get auth token for HMS
          addDebugInfo('Getting auth token for HMS...');
          const tokenUrl = `/.netlify/functions/getToken?roomId=${roomId}&role=${role}`;
          
          const tokenRes = await fetch(tokenUrl);
          const responseText = await tokenRes.text();
          
          if (!tokenRes.ok) {
            throw new Error(`Token fetch failed (${tokenRes.status}): ${responseText}`);
          }

          let tokenData;
          try {
            tokenData = JSON.parse(responseText);
          } catch (e) {
            throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}`);
          }
          
          if (!tokenData.token) {
            throw new Error("No token received from server");
          }

          addDebugInfo('‚úÖ Token received, initializing HMS call...');
          await initializeHMSCall(roomId, role, tokenData.token);
        } else {
          addDebugInfo('HMS SDK failed to load, using fallback...');
          await initializeFallbackCall(roomId, role);
        }

        loadingDiv.style.display = 'none';

      } catch (error) {
        addDebugInfo(`‚ùå Application error: ${error.message}`);
        showError(error.message);
        loadingDiv.style.display = 'none';
        
        // Try fallback even if everything else failed
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const role = urlParams.get("role") || "sister";
          await initializeFallbackCall(urlParams.get("room"), role);
        } catch (fallbackError) {
          addDebugInfo(`‚ùå Fallback also failed: ${fallbackError.message}`);
        }
      }
    }

    // Start the application when DOM is loaded
    document.addEventListener("DOMContentLoaded", initializeApp);
  </script>
</body>
</html>
