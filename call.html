<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rakhi Video Call</title>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f2f2f2;
    }

    h1 {
      margin-top: 20px;
    }

    #loading {
      margin: 20px;
      padding: 20px;
      background: #fff3cd;
      border-radius: 5px;
      color: #856404;
    }

    #error {
      margin: 20px;
      padding: 20px;
      background: #f8d7da;
      border-radius: 5px;
      color: #721c24;
    }

    #status {
      margin: 10px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }

    #controls {
      margin: 10px;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    #video-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    video {
      width: 300px;
      height: 200px;
      background: black;
      border-radius: 10px;
      object-fit: cover;
    }

    .peer-wrapper {
      position: relative;
      display: inline-block;
    }

    .peer-name {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: white;
      background: rgba(0,0,0,0.7);
      padding: 5px;
      border-radius: 5px;
      font-size: 12px;
    }

    .audio-only {
      width: 300px;
      height: 200px;
      background: #333;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-direction: column;
    }

    .debug-info {
      margin: 10px;
      padding: 10px;
      background: #e2e3e5;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      max-width: 800px;
      max-height: 200px;
      overflow-y: auto;
    }

    .fallback-notice {
      margin: 20px;
      padding: 20px;
      background: #d1ecf1;
      border-radius: 5px;
      color: #0c5460;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>üé• Raksha Bandhan Call</h1>
  
  <div id="loading">Loading video call...</div>
  <div id="error" style="display: none;"></div>
  <div id="debug" class="debug-info" style="display: none;"></div>
  <div id="status" style="display: none;"></div>
  <div id="controls" style="display: none;">
    <button id="toggleAudio" class="btn-primary">üé§ Toggle Audio</button>
    <button id="toggleVideo" class="btn-primary">üìπ Toggle Video</button>
    <button id="leaveRoom" class="btn-danger">üö™ Leave Room</button>
  </div>
  <div id="video-container"></div>

  <script>
    let currentStream = null;
    let isAudioMuted = false;
    let isVideoMuted = false;
    let hmsSDK = null;

    // Debug function
    function addDebugInfo(message) {
      const debugDiv = document.getElementById('debug');
      debugDiv.style.display = 'block';
      debugDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
      console.log(message);
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.style.display = 'block';
      errorDiv.innerHTML = `‚ùå ${message}`;
      addDebugInfo(`ERROR: ${message}`);
    }

    function updateStatus(message, bgColor, textColor) {
      const statusDiv = document.getElementById('status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = message;
      statusDiv.style.background = bgColor;
      statusDiv.style.color = textColor;
    }

    // Debug what objects are available in window
    function debugWindowObjects() {
      const hmsRelated = [];
      for (let key in window) {
        if (key.toLowerCase().includes('hms') || key.toLowerCase().includes('100ms')) {
          hmsRelated.push(key);
        }
      }
      addDebugInfo(`HMS-related objects in window: ${hmsRelated.join(', ')}`);
      
      // Also check for common SDK patterns
      const commonObjects = ['HMS', 'HMSReactiveStore', 'HMSVideoStore', 'HMSSDK', 'HMSStore', 'HMSActions'];
      commonObjects.forEach(obj => {
        if (window[obj]) {
          addDebugInfo(`‚úÖ Found ${obj}:`, typeof window[obj]);
          if (typeof window[obj] === 'object') {
            addDebugInfo(`${obj} properties: ${Object.keys(window[obj]).join(', ')}`);
          }
        }
      });
    }

    // Try to load HMS SDK with better object detection
    async function loadHMSSDK() {
      const sdkConfigs = [
        {
          url: 'https://unpkg.com/@100mslive/hms-video-store@latest/dist/index.js',
          checkObjects: ['HMSReactiveStore', 'HMS', 'HMSVideoStore']
        },
        {
          url: 'https://cdn.jsdelivr.net/npm/@100mslive/hms-video-store@latest/dist/index.js',
          checkObjects: ['HMSReactiveStore', 'HMS', 'HMSVideoStore']
        },
        {
          url: 'https://sdk.100ms.live/web/hms.js',
          checkObjects: ['HMSReactiveStore', 'HMS', 'HMSSDK']
        }
      ];

      for (const config of sdkConfigs) {
        try {
          addDebugInfo(`Trying to load HMS SDK from: ${config.url}`);
          
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = config.url;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
            
            // Timeout after 15 seconds
            setTimeout(() => reject(new Error('Timeout')), 15000);
          });

          // Wait longer for SDK to initialize
          await new Promise(resolve => setTimeout(resolve, 2000));

          // Debug what's available
          debugWindowObjects();

          // Check for HMS objects
          for (const objName of config.checkObjects) {
            if (window[objName]) {
              addDebugInfo(`‚úÖ Found ${objName}!`);
              hmsSDK = window[objName];
              
              // Try to set up the proper structure
              if (objName === 'HMS' && !window.HMSReactiveStore) {
                if (hmsSDK.HMSReactiveStore) {
                  window.HMSReactiveStore = hmsSDK.HMSReactiveStore;
                  addDebugInfo('‚úÖ Set up HMSReactiveStore from HMS object');
                } else if (hmsSDK.HMSStore) {
                  window.HMSReactiveStore = {
                    HMSStore: hmsSDK.HMSStore,
                    HMSActions: hmsSDK.HMSActions,
                    HMSNotifications: hmsSDK.HMSNotifications
                  };
                  addDebugInfo('‚úÖ Created HMSReactiveStore structure from HMS object');
                }
              }
              
              return true;
            }
          }

          addDebugInfo(`‚ùå No HMS objects found from ${config.url}`);
        } catch (error) {
          addDebugInfo(`‚ùå Failed to load from ${config.url}: ${error.message}`);
        }
      }

      return false;
    }

    // HMS-based implementation with better error handling
    async function initializeHMSCall(roomId, role, authToken) {
      try {
        addDebugInfo('Initializing HMS call...');
        
        // Try different ways to access HMS classes
        let HMSStore, HMSActions, HMSNotifications;
        
        if (window.HMSReactiveStore) {
          HMSStore = window.HMSReactiveStore.HMSStore;
          HMSActions = window.HMSReactiveStore.HMSActions;
          HMSNotifications = window.HMSReactiveStore.HMSNotifications;
        } else if (hmsSDK) {
          HMSStore = hmsSDK.HMSStore;
          HMSActions = hmsSDK.HMSActions;
          HMSNotifications = hmsSDK.HMSNotifications;
        }

        if (!HMSStore || !HMSActions) {
          throw new Error('HMS classes not found');
        }

        addDebugInfo('‚úÖ HMS classes found, creating store...');

        const hmsStore = new HMSStore();
        const hmsActions = new HMSActions(hmsStore);
        const hmsNotifications = HMSNotifications ? new HMSNotifications(hmsStore) : null;

        addDebugInfo('‚úÖ HMS objects created successfully');

        // Set up notifications if available
        if (hmsNotifications) {
          hmsNotifications.onNotification((notification) => {
            addDebugInfo(`HMS Notification: ${notification.type} - ${JSON.stringify(notification.data)}`);
            if (notification.type === 'ERROR') {
              showError(`HMS Error: ${notification.data.message}`);
            }
          });
        }

        // Subscribe to store changes
        hmsStore.subscribe((store) => {
          addDebugInfo(`Store update: connected=${store.isConnected}, peers=${Object.keys(store.peers || {}).length}, state=${store.connectionState}`);
          
          if (store.isConnected) {
            updateStatus(`‚úÖ Connected as ${store.localPeer?.name} | Peers: ${Object.keys(store.peers || {}).length}`, '#d4edda', '#155724');
            document.getElementById('controls').style.display = 'flex';
          } else {
            updateStatus(`üîÑ ${store.connectionState || 'Connecting'}...`, '#fff3cd', '#856404');
          }

          // Update video container
          updateVideoContainer(store, hmsActions);
        });

        // Join room
        addDebugInfo('Attempting to join room...');
        await hmsActions.join({
          userName: role === "sister" ? "Sister" : "Brother",
          authToken: authToken,
          settings: {
            isAudioMuted: false,
            isVideoMuted: false,
          },
        });

        addDebugInfo('‚úÖ Join request sent successfully');

        // Set up controls
        setupHMSControls(hmsActions);

      } catch (error) {
        addDebugInfo(`‚ùå HMS call failed: ${error.message}`);
        addDebugInfo(`Error stack: ${error.stack}`);
        throw error;
      }
    }

    function updateVideoContainer(store, hmsActions) {
      const container = document.getElementById('video-container');
      container.innerHTML = '';

      if (!store.peers) {
        addDebugInfo('No peers in store');
        return;
      }

      Object.values(store.peers).forEach(peer => {
        addDebugInfo(`Processing peer: ${peer.name} (${peer.id})`);
        
        if (peer.videoTrack && store.tracks) {
          const videoTrack = store.tracks[peer.videoTrack];
          if (videoTrack && videoTrack.enabled) {
            addDebugInfo(`Adding video for ${peer.name}`);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'peer-wrapper';
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            video.muted = peer.isLocal;
            
            const nameLabel = document.createElement('div');
            nameLabel.className = 'peer-name';
            nameLabel.textContent = peer.name + (peer.isLocal ? ' (You)' : '');
            
            wrapper.appendChild(video);
            wrapper.appendChild(nameLabel);
            container.appendChild(wrapper);
            
            hmsActions.attachVideo(videoTrack.id, video);
          }
        } else if (peer.audioTrack && store.tracks) {
          const audioTrack = store.tracks[peer.audioTrack];
          if (audioTrack && audioTrack.enabled) {
            addDebugInfo(`Adding audio-only peer: ${peer.name}`);
            
            const audioDiv = document.createElement('div');
            audioDiv.className = 'audio-only';
            audioDiv.innerHTML = `
              <div style="font-size: 48px;">üé§</div>
              <div style="margin-top: 10px;">${peer.name}${peer.isLocal ? ' (You)' : ''}</div>
            `;
            container.appendChild(audioDiv);
          }
        }
      });
    }

    function setupHMSControls(hmsActions) {
      document.getElementById('toggleAudio').onclick = async () => {
        try {
          await hmsActions.setLocalAudioEnabled(isAudioMuted);
          isAudioMuted = !isAudioMuted;
          addDebugInfo(`Audio ${isAudioMuted ? 'muted' : 'unmuted'}`);
        } catch (error) {
          addDebugInfo(`Failed to toggle audio: ${error.message}`);
        }
      };

      document.getElementById('toggleVideo').onclick = async () => {
        try {
          await hmsActions.setLocalVideoEnabled(isVideoMuted);
          isVideoMuted = !isVideoMuted;
          addDebugInfo(`Video ${isVideoMuted ? 'muted' : 'unmuted'}`);
        } catch (error) {
          addDebugInfo(`Failed to toggle video: ${error.message}`);
        }
      };

      document.getElementById('leaveRoom').onclick = async () => {
        try {
          await hmsActions.leave();
          document.getElementById('video-container').innerHTML = '';
          document.getElementById('controls').style.display = 'none';
          updateStatus('üëã Left the room', '#d1ecf1', '#0c5460');
          addDebugInfo('‚úÖ Left room successfully');
        } catch (error) {
          addDebugInfo(`Failed to leave room: ${error.message}`);
        }
      };
    }

    // Fallback WebRTC implementation (unchanged)
    async function initializeFallbackCall(roomId, role) {
      addDebugInfo('Using fallback WebRTC implementation');
      
      const container = document.getElementById('video-container');
      document.getElementById('controls').style.display = 'flex';
      
      // Add fallback notice
      const notice = document.createElement('div');
      notice.className = 'fallback-notice';
      notice.innerHTML = `
        <strong>üìπ Local Camera Mode</strong><br>
        HMS SDK couldn't load properly, showing your local camera only.<br>
        Share this URL with others: <code>${window.location.href}</code>
      `;
      document.body.insertBefore(notice, container);

      try {
        currentStream = await navigator.mediaDevices.getUserMedia({ 
          video: true, 
          audio: true 
        });

        const wrapper = document.createElement('div');
        wrapper.className = 'peer-wrapper';
        
        const video = document.createElement('video');
        video.srcObject = currentStream;
        video.autoplay = true;
        video.playsInline = true;
        video.muted = true;
        
        const nameLabel = document.createElement('div');
        nameLabel.className = 'peer-name';
        nameLabel.textContent = `${role === 'sister' ? 'Sister' : 'Brother'} (You)`;
        
        wrapper.appendChild(video);
        wrapper.appendChild(nameLabel);
        container.appendChild(wrapper);

        updateStatus('‚úÖ Local camera connected (Fallback mode)', '#d4edda', '#155724');

        // Set up fallback controls
        document.getElementById('toggleAudio').onclick = () => {
          const audioTracks = currentStream.getAudioTracks();
          audioTracks.forEach(track => {
            track.enabled = !track.enabled;
            isAudioMuted = !track.enabled;
          });
          document.getElementById('toggleAudio').textContent = 
            isAudioMuted ? 'üîá Unmute Audio' : 'üé§ Mute Audio';
        };

        document.getElementById('toggleVideo').onclick = () => {
          const videoTracks = currentStream.getVideoTracks();
          videoTracks.forEach(track => {
            track.enabled = !track.enabled;
            isVideoMuted = !track.enabled;
          });
          document.getElementById('toggleVideo').textContent = 
            isVideoMuted ? 'üì∑ Enable Video' : 'üìπ Disable Video';
        };

        document.getElementById('leaveRoom').onclick = () => {
          if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
          }
          container.innerHTML = '';
          document.getElementById('controls').style.display = 'none';
          updateStatus('üëã Left the room', '#d1ecf1', '#0c5460');
        };

      } catch (error) {
        showError(`Camera access failed: ${error.message}`);
      }
    }

    // Main application logic
    async function initializeApp() {
      const loadingDiv = document.getElementById('loading');
      
      try {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get("room");
        const role = urlParams.get("role") || "sister";

        if (!roomId) {
          throw new Error("No room ID provided in URL. Please add ?room=YOUR_ROOM_ID to the URL");
        }

        addDebugInfo(`Starting app: room=${roomId}, role=${role}`);

        // Try to load HMS SDK
        const hmsLoaded = await loadHMSSDK();
        
        if (hmsLoaded) {
          // Get auth token for HMS
          addDebugInfo('Getting auth token for HMS...');
          const tokenUrl = `/.netlify/functions/getToken?roomId=${roomId}&role=${role}`;
          
          const tokenRes = await fetch(tokenUrl);
          const responseText = await tokenRes.text();
          
          if (!tokenRes.ok) {
            throw new Error(`Token fetch failed (${tokenRes.status}): ${responseText}`);
          }

          let tokenData;
          try {
            tokenData = JSON.parse(responseText);
          } catch (e) {
            throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}`);
          }
          
          if (!tokenData.token) {
            throw new Error("No token received from server");
          }

          addDebugInfo('‚úÖ Token received, initializing HMS call...');
          await initializeHMSCall(roomId, role, tokenData.token);
        } else {
          addDebugInfo('HMS SDK failed to load, using fallback...');
          await initializeFallbackCall(roomId, role);
        }

        loadingDiv.style.display = 'none';

      } catch (error) {
        addDebugInfo(`‚ùå Application error: ${error.message}`);
        showError(error.message);
        loadingDiv.style.display = 'none';
        
        // Try fallback even if everything else failed
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const role = urlParams.get("role") || "sister";
          await initializeFallbackCall(urlParams.get("room"), role);
        } catch (fallbackError) {
          addDebugInfo(`‚ùå Fallback also failed: ${fallbackError.message}`);
        }
      }
    }

    // Start the application when DOM is loaded
    document.addEventListener("DOMContentLoaded", initializeApp);
  </script>
</body>
  </html>
